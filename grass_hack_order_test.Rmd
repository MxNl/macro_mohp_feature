---
title: "Calculation of Hack Stream Order from Distance Raster using Whitebox Tools"
subtitle: "Test"
output: 
  html_document:
    toc: true
    number_sections: true
    toc_float:
      collapsed: false
      smooth_scroll: false
    highlight: tango
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, fig.fullwidth = TRUE, fig.height = 12)
```


# Packages
```{r, message=FALSE, warning=FALSE}
library(targets)
library(raster)
library(sf)
library(lwgeom)
library(stars)
library(furrr)
library(janitor)
library(patchwork)
library(assertr)
library(tarchetypes)
library(mapview)
library(tidyverse)
library(rgeos)
library(here)
library(rgrass7)
library(whitebox)
```


# Import Data and Custom Functions
```{r}
source("R/constants.R")
source("R/plot_functions.R")
source("R/preprocessing_functions.R")
source("R/database_functions.R")
source("R/postgis_functions.R")
source("R/grass_functions.R")

table_name <- LINES_BY_STREAMORDER
reference_raster <- tar_read(reference_raster)
filepaths_reference_raster <- tar_read(filepaths_reference_raster_write)
studyarea <- tar_read(selected_studyarea)
```

Import river data from Postgis database
```{r}
streamorder <- 1

lines <-
  table_name %>%
  composite_name(streamorder) %>%
  get_table_from_postgress() %>%
  query_result_as_sf() %>%
  add_feature_index_column() %>%
  mutate(feature_id = as.integer(feature_id))
```

Plot river data
```{r}
lines %>% 
  mutate(strahler = as.character(strahler)) %>% 
  plot_lines_coloured_by_categorical_attribute(strahler, plot_legend = TRUE)
```

# Initiate GRASS Database

```{r}
initiate_grass_db(studyarea)
    
crs_reference_raster <- crs(reference_raster)
```

# Write Data to Database

```{r}
use_sf()
lines %>%
  st_transform(crs_reference_raster) %>%
  writeVECT("river_network",
    v.in.ogr_flags = c("overwrite")
  )

use_sp()
execGRASS("r.import",
  input = FILEPATH_REFERENCE_RASTER_OUTPUT,
  output = "reference_raster"
)

execGRASS("g.region",
  flags = c("quiet"),
  raster = "reference_raster"
)

use_sf()
studyarea %>%
  st_transform(crs_reference_raster) %>%
  writeVECT("mask",
    v.in.ogr_flags = c("overwrite")
  )
```

# Calculations in GRASS

Create mask
```{r}
execGRASS("r.mask",
  vector = "mask",
  flags = c("overwrite")
)
```

Rivers as raster
```{r}
execGRASS("v.to.rast",
  input = "river_network",
  output = "river_network_raster",
  use = "attr",
  attribute_column = "feature_id",
  flags = c("overwrite")
)
```

Cleaning of river raster
```{r}
execGRASS("r.mapcalc",
  expression = "river_network_raster = round(river_network_raster)",
  flags = c("overwrite")
)

execGRASS("r.null",
  map = "river_network_raster"
)

execGRASS("r.thin",
  input = "river_network_raster",
  output = "river_network_value_raster_thin",
  flags = c("overwrite")
)
```

Plot river raster
```{r}
use_sp()
readRAST("river_network_value_raster_thin") %>%
  raster() %>%
  plot()
```

Write river raster to disk
```{r}
readRAST("river_network_value_raster_thin") %>%
  raster() %>%
  writeRaster("output_data/river_network_value_raster_thin.tif", overwrite = TRUE)
```


Calculate distance to nearest river
```{r}
execGRASS("r.grow.distance",
  input = "river_network_value_raster_thin",
  distance = "river_network_distance_raster",
  value = "river_network_value_raster",
  flags = c("overwrite")
)
```

Plot the resulting raster
```{r}
use_sp()
readRAST("river_network_distance_raster") %>%
  raster() %>%
  plot()
```
Create sythetic DEM from distance raster
```{r}
execGRASS("v.to.rast",
  input = "river_network",
  output = "river_network_raster_strahler",
  use = "attr",
  attribute_column = "strahler",
  flags = c("overwrite")
)

execGRASS("r.mapcalc",
  expression = "river_network_raster_strahler = round(river_network_raster_strahler)",
  flags = c("overwrite")
)

execGRASS("r.null",
  map = "river_network_raster_strahler"
)

execGRASS("r.thin",
  input = "river_network_raster_strahler",
  output = "river_network_raster_strahler_thin",
  flags = c("overwrite")
)
print("r.thin")
execGRASS("r.grow.distance",
  input = "river_network_raster_strahler_thin",
  value = "river_network_value_raster_strahler",
  flags = c("overwrite")
)

execGRASS("r.mapcalc",
  expression = "synthetic_dem = river_network_distance_raster - river_network_value_raster_strahler + 10",
  flags = c("overwrite")
)
```

Plot synthetic DEM
```{r}
use_sp()
readRAST("synthetic_dem") %>%
  raster() %>%
  plot()
```


Write DEM to disk
```{r}
use_sp()
readRAST("synthetic_dem") %>%
  raster() %>%
  writeRaster("output_data/synt_elevation.tif", overwrite = TRUE)
```

# Calculations with Whitebox

Generate flow direction raster
```{r}
wbt_d8_pointer("output_data/synt_elevation.tif", output = "output_data/test_pointer.tif")
```

Plot it
```{r}
raster("output_data/test_pointer.tif") %>%
  plot()
```

Calculate main stems
```{r}
wbt_find_main_stem(
  "output_data/test_pointer.tif",
  "output_data/river_network_value_raster_thin.tif",
  output = "output_data/mainstems.tif"
)
```

# Result
... and plot it
```{r}
raster("output_data/mainstems.tif") %>%
  plot()
```

The result only reflects feature_id of the river segments and not hack stream order.
