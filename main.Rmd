---
title: "Multiorder Hydrologic Position in Europe as a Set of Metrics in Support of Groundwater Mapping at Regional and National Scales"
author:
  - name: Maximilian Noelscher
    affiliation:
    - Federal Institute for Geosciences and Natural Resources (BGR), Berlin, Germany
abstract: |
  This dataset (EU-MOHP v013.0.1) provides information on the multiorder hydrologic position of a geographic point within its respective river network and catchment as gridded maps. More precisely, it comprises the three measures “lateral position” as a relative measure of the position between the stream and the catchment boundary/ watershed, “divide stream distance” as an absolute distance measure that serves as a proxy for the position within the catchment and “stream distance” as an absolute measure of the distance to the nearest stream. These three measures were calculated for several hydrologic orders to reflect different spatial scales. Its spatial extent covers major parts of physiographical Europe or the European Economic Area (EEA39). Although there might be many potential use cases, this dataset serves predominantly as valuable static geophysical or environmental predictor variable among other input data for mapping or regionalization tasks in the context of hydrogeology and hydrology using machine learning.
output: 
  bookdown::pdf_document2:
    number_sections: FALSE
    template: scienctific_data_template.tex
    keep_tex: yes
    fig_crop: TRUE
bibliography: 
  - eumohp.bib
urlcolor: black
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.align = 'center', fig.pos = "H", message = FALSE, warning = FALSE, fig.showtext = TRUE)
options(tinytex.verbose = TRUE)
knitr::knit_hooks$set(crop = knitr::hook_pdfcrop)

library(knitr)
library(showtext)

# source("../../R/constants.R")
```

```{r, echo=FALSE, include = FALSE}
options(encoding = "UTF-8")

RefManageR::ReadZotero("5574385",
               .params = list(collection = "U4DY76U3",
                              key = "V0zS3yc7zT1NsT1bfHG6sfYQ")) %>%
      bibtex::write.bib("eumohp.bib")
# 
# renv::dependencies()$Package %>%
#       purrr::chuck(1) %>%
#       # knitr::write_bib() %>% 
#       bibtex::write.bib("packages.bib", append = TRUE)
```


<!--
```{r eval=FALSE, code=readLines("data_descriptor/targets/R/visualization_functions.R")}
 
```
-->


# Background & Summary

<!-- *[Background]* -->

In recent years, data science tools such as machine learning are increasingly applied to and specifically developed for hydro(geo)logical challenges and research questions (!!source: Zounemat 2020). In the field of hydrogeology, machine learning has been used successfully for groundwater level prediction and a variety of mapping tasks (!!source: wunsch 2021; knoll, desimone). Since machine learning models -- except for hydrid- or physics-guided models -- are purely based on data with no built-in knowledge of physical processes, it is important to provide as many features (synonyms: predictor variables, explanatory variables) as possible that have an impact on the target variable to potentially enable the machine learning algorithm to reproduce the result of the underlying process. For surface and near-surface processes, this criterion may be more or less satisfiable through the availability of remote sensing data, whereas for modeling subsurface processes such as in hydrogeology, this poses a serious challenge.

<!-- *[Motivation/goals]* -->

The key motivation of this dataset is to provide a set of features that introduce hydrological context to machine learning models regarding the horizontal position of a point within its catchment. Therefore, it functions as a proxy for multiple geophysical characteristics of a hydrologic system. It complements commonly available data sets and tackles the above mentioned challenge.
This dataset is strongly inspired by [!!source: Beelitz et. al.] and adapts their ideas and methods to the “EU-Hydro - River Network Database” but – in contrast – with purely free open source software and a strong focus on reproducibility. [!!source: Beelitz et. al.] provides a comprehensive explanation of the motivation as well as a detailed discussion for further reading.

<!-- *[context of previous work and the literature]* -->

In their study, @belitz_multiorder_2019 also provide the results from case studies to proof that the multiorder hydrologic position is a valuable feature when mapping divers geophysical targets using machine learning. Its benefit to the performance of machine learning models has also been acknowledged by several other studies [!!source: Using Boosted Regression Tree Models to Predict Salinity in Mississippi Embayment Aquifers, Central United States; Machine Learning Predictions of pH in the Glacial Aquifer System, Northern USA; Machine-learning models to map pH and redox conditions in groundwater in a layered aquifer system, Northern Atlantic Coastal Plain, eastern USA; The relation of geogenic contaminants to groundwater age, aquifer hydrologic position, water type, and redox conditions in Atlantic and Gulf Coastal Plain aquifers, eastern and south-central USA].

<!-- *[potential reuse]* -->

Being a static geophysical catchment attribute, the EU-MOHP data set can be used as features in any machine learning task in the domain of hydrology and hydrogeology. Because of the calculation based on the different stream orders, this data set can be applied for multiple spatial scales and depths -- from local via regional to continental scales. Examples of use cases might be the mapping of hydrogeochemical parameters or hydraulic variables like depth to groundwater, the prediction of groundwater levels or catchment classification tasks using unsupervised machine learning methods.

<!-- *[schematic overview of the study and assay(s) design]* -->

The EU-MOHP v013.0.1 data set comprises the `r FEATURE_NAMES %>% length()` measures 

 - lateral position (LP)
 - divide stream distance (DSD) and
 - stream distance (SD)
 
for each of the `r tar_read(streamorders) %>% length()` stream orders which leads to $n_{measures}\cdot n_{streamorders} = `r length(FEATURE_NAMES) * length(tar_read(streamorders))`$ different metrics to be used as features. Spatially, the data set covers major parts of physiographical Europe and all of the 39 countries in European Economic Area (EEA39). More precisely, it covers the `r tar_read(selected_studyarea) %>% nrow()` largest coherent land masses of the EEA39 (see fig. \@ref(fig:studyareafigure)).

<!-- ## EU-MOHP Concept -->

Conceptually, the three measures LP, DSD and SD of EU-MOHP are based on the idea that the location in hydologic systems matters. A location can be e.g. close to the confluence of two large rivers or in another extreme close the catchment boundary of headwater streams. The location or hyrdologic position refers to the position of a point between a stream and its divide/ catchment boundary. Thiessen divides were used as catchment boundaries instead of divides that are generated from digital elevation models. One major advantage is that Thiessen divides can be calculated purely based on the river network itself while avoiding closed lows in the resulting metrics (!!source:belitz). A Thiessen divide is the outline of a Thiessen catchment which is the area that contains all points to which a stream is closer than any other stream (!!source Johnston). A discussion on the utilisation of Thiessen catchments can be found in !!source:Belitz and !!source:Johnston.

The overall concept also includes the spatial scale, as the role of different hydrologic processes can vary depending on the scale. This issue is addressed by calculating the EU-MOHP measures for different hydrologic orders which leads to the above mentioned metrics. For a specific hydrologic order $i$, only streams with a stream order $>= i$ were used (e.g. for stream order 2, all streams with stream order 2, 3, 4 and greater, compare fig. \@ref(fig:schematicmohp)A and B). Here, the stream orders are defined according to !!source Strahler where all streams without tributaries are assigned to the first stream order (headwater streams). The stream order downstream of a confluence increases by 1 if the upstream stream orders are equal. If the stream orders are not equal, it inherits the greater stream order. Therefore, each stream order reflects a different scale.

Based on the river network and the Thiessen divides, the EU-MOHP measures (LP, DSD, SD) can be calculated as follows:

\begin{equation}
LP_i = \frac{DS_i}{DS_i + DD_i} (\#eq:eqlp)
\end{equation}

\begin{equation}
DSD_i = DS_i + DD_i (\#eq:eqdsd)
\end{equation}

\begin{equation}
SD_i = DS_i (\#eq:eqsd)
\end{equation}

\noindent
where $i$ is the hydrologic order, $DS$ is the horizontal distance to the nearest stream (see fig. \@ref(fig:schematicmohp)) and $DD$ is the horizontal distance to the nearest divide without crossing a stream (see fig. \@ref(fig:schematicmohp)). This condition arises from the fact that water flows towards the topographically lowest points namely the streams. 


# Methods {-}

Most processing and calculation steps were done using the R programming language [see fig. \@ref(fig:workflowfigure)C`;`{=latex} @r_core_team_r_2020]. Due to the memory size of this data set as well as for the sake of computational speed, a PostgreQL database with PostGIS extension was used for some processing steps of vector data and GRASS GIS database was used for all final calculations of the MOHP metrics (see fig. \@ref(fig:workflowfigure)D and E). For reproducability and programming reasons, all processing steps including the databases were tracked and executed through a data processing pipeline using the targets package in R [see fig. \@ref(fig:workflowfigure)`;`{=latex} @landau_targets_2021]. More details can be found in section [Processing Steps] or in the code itself (see section [Code availability]). This processing or targets pipeline can be seen as programming script that tracks each step and skips processing steps that are still up-to-date when re-running the script.

The resulting EU-MOHP metrics (see fig. \@ref(fig:workflowfigure)G) are written into the sub-directories `r FEATURE_NAMES %>% str_c("'", ., "'") %>% str_c(collapse = ", ")` of `output_data` as gridded maps in GeoTiff (.tif) file format. The data descriptor is stored in `output_data` in Latex (.tex) file format.

## Directory and file structure

The directory and file structure is summarizes in fig. \@ref(fig:projectdirtree) as tree. Files and directories that are not relevant for describing the methods are not shown. The file `config.yml` (line !!1) contains definitions of variables that are meant to be changed by a user before running the script. The most relevant variable is `cellsize` which sets the raster cell width of the resulting EU-MOHP gridded maps. Another important variable is `area` to switch between a test study area and the complete study area for all EEA39. The test study area reduces the calculation time for pipeline testing purposes. The folder `grassdata` (line !!2) contains the Grass Gis databases. The file `macro_mohp_feature.Rproj` (line !!3) is the R project file. `output_data` (line !!5) contains sub-directories where the final EU-MOHP gridded maps are written to. `R` (line 9) contains R scripts where custom functions and constants are defined. `renv` (line !!19) and the file `renv.lock` (line !!25) are related to the R package `renv` for improved reproducability through managing R dependencies. The R script `run_pipeline.R` contains code to execute the targets pipeline that does all the data processing and calculations. `targets` (line !!27) contains the definition of all targets or processing steps of the pipeline. For overview reasons, it is split thematically across multiple files. `_targets` (line !!35) is used ba the targets package internally. The file `_targets.R` (line !!39) sets up the processing pipeline and loads all dependencies.

The description of the methods will be structured by following the chronological order of the processing steps in the targets pipeline as it can be found in the code. This order is mainly guided by the dependencies of the processing steps. To better refer to the code, each processing step provides the name of its respective target name in the targets pipeline and the file containing relevant code. The targets marked as `(helper target)` are not described here because they are not relevant to the methods and exist only for technical reasons.

## Underlying Data Set

The generation of this data set is based on two basic data products which are the “EU-Hydro -- River Network Database” and “EU-Hydro -- Coastline” with the advantage that the dependencies are low from a data point of view. Therefore, it is possible to transfer the methodology to other regions with only little effort. For the calculation of the MOHP metrics in general, the following 4 essential data layers are required:

 1. river network: vector layer with linestring geometries
 2. surface water bodies (e.g. lakes, wide rivers): vector layer with polygon geometries
 3. river basins or study area: vector layer with polygon geometries
 4. coastline: vector layer with linestring geometries
 
In this case, they were derived from the previously mentioned data sources. 
The “EU-Hydro -- River Network Database” as well as the coastline were manually downloaded from the Copernicus - Land Monitoring Service website (see fig. \@ref(fig:workflowfigure)A) in GeoPackage (.gpkg) and in Shape (.shp) file format, respectively [see fig. \@ref(fig:workflowfigure)B`;`{=latex} @noauthor_eu-hydro_2021; @noauthor_eu-hydro_2021]. The river network data is split into 2 .gpkg files for each of `r targets::tar_read(river_networks_files) %>% length()` the major river basins. All unzipped files together have a size of approximately 14GB. The single .shp file containing the coastline has a size of 288MB.


## Data import

The river network comprises the layers `r STREAM_TYPE_TO_INCLUDE %>% str_c("'", ., "'") %>% str_c(collapse = ", ")` in the "euhydro_\<name of the river basin\>\_v013" named .gpkg file of all river basins of the river network data. They are imported with the target "river_networks" in "import_targets.R" (see fig. \@ref(fig:projectdirtree), line !!29). The layer "Canals_l" contains canals, which are defined as "an artificial waterway with no flow, or a controlled flow, usable or built for navigation" (!!source:EU-Hydroreport). The layer "Ditches_l" contains ditches, which are defined as "an artificial waterway with no flow, or a controlled flow, usually unlined, used for draining or irrigating land" (!!source:EU-Hydroreport). The layer "Rivers_l" contains rivers, which are defined as "a naturally flowing watercourse" (!!source:EU-Hydroreport). 

The surface water bodies are derived from the layer 'InlandWater'. This layer is imported with the target "inland_waters" in "import_targets.R" and contains inland water defined as "a large body of water entirely surrounded by land." (!!source:EU-Hydroreport). In this step, all geometries with an area smaller than $4 \cdot Cellsize = `r CELLSIZE^2 * 4`m^2$, where $Cellsize$ is the area of raster cells, are removed.

The river basins are based on the layer "\<name of river basin\>\_eudem2_basins_h1" in the "drainage_network_\<name of the river basin\>\_public_beta_v009" named .gpkg file. This layer is imported with the target "river_basins" in "studyarea_targets.R" (see fig. \@ref(fig:projectdirtree), line !!32) and contains polygon geometries of all sub-basins of a basin. The spatial coverage of the river basins is the basis for the study area. The study area itself delineates the area for which the EU-MOHP metrics will be calculated.

The fourth required data layer is the coastline. It is imported with the target "coastline_grouped" in "studyarea_targets.R" (see fig. \@ref(fig:projectdirtree), line !!32).

In this study, we used the coordinate reference system (CRS) ETRS89-extended / LAEA Europe with the EPSG code `r CRS_REFERENCE`. Therefore, all data was reprojected to this CRS after importing in case it differed. 

## Preprocessing -- River Basins

Firstly, the preprocessing steps related to the river basins are described because they aim on the determination of a study area, which is required for subsequent processing steps. This study area also serves as basis for which the EU-MOHP measures are calculated. The following steps refer to targets that can be found in the file "studyarea_targets.R" (see fig. \@ref(fig:projectdirtree), line !!32). After the previously mentioned import, the sub-basins were unioned basin-wise (target: river_basins_unioned). Then, all polygons belonging to European oversea territories such as the French islands in the Caribbean were removed (target: river_basins_subset). The resulting polygon geometries were unioned in the PostGIS database (target: river_basins_subset_union_in_db). The PostGIS database has reduced the run-time of the union drastically compared to R. The polygon geometries have a large amount of nodes due to the high details in the digitized coastline which causes long run-times in R. Subsequently, out of these polygons of contiguous land masses the 10 area-wise largest polygons were chosen as study area (target: river_basins_region_name). Lastly, names were assigned to each of the polygons (target: selected_studyarea).

## Preprocessing -- River Network

After the data import, the next step is the filtering of linestring geometries from the river network based on attribute columns `DFDD` and `HYP` (target: river_networks_non_dry_selected_streamtypes). `DFDD` classifies the geometries into BH140 (river), BH020 (canal) and BH030 (ditch). Canals and ditches were removed from the river network by only keeping the geometries with the value "BH140" for several reasons. Many of the canal and ditch geometries have missing stream order values, which is required for the following processing steps. Another reason is the assumption that canals might be hydraulically disconnected to the natural hydrologic system through walls with low permeability. Lastly, the overall importance of canals and ditches is low when comparing the number of geometries to rivers as shown in fig. \@ref(fig:dfddstatsbarplot). The section [Technical Validation] provides a discussion on this issue. `HYP` classifies the geometries into the following degrees of hydrologic persistence: 1 (Perennial), 2 (Intermittent), 3 (Ephemeral) and 4 (Dry). Geometries with the value 4 (Dry) were removed. Then, missing and invalid stream order values are imputed the with the value 1 to include them in the first hydrologic order (target: river_networks_imputed_streamorder_canals_as_1). The river network geometries were clipped to the study area by only keeping geometries that intersect with the study area (target: db_river_networks_strahler_studyarea). The next processing step implements a method to obtain linestring geometries that reflect the mainstems of the rivers and its tributaries (target: rivernetworks_merged_per_streamorder). This is achieved by merging the geometries by a column containing an unique id for each mainstem. The mainstem is defined here as the longest path from the head water to the most distant river mouth. As the underlying river network data has no column providing this information, it is necessary to first generate this column by which we will conduct the merging of the lines (!!source:: Belitz used the already existing column `LevelPathI` from their underlying river network data set). For doing so, it is now required to derive a river network for each hydrologic order seperately. This is achieved by 

# Hardware {-}
The pipeline to generate the data set was executed on a DELL PowerEdge C4140 Server with an Intel Xeon Gold 6240R CPU and 384 GB installed RAM. The installed operation system is Microsoft Windows Server 2019 Standard, version 10.0.17763 Build 17763.

[what is different to the Belitz Paper and why]
NHDPlusV2 data
No pathleveId column
Criterion to exclusively use free open source software

# Data Records {-}

Text.

# Technical Validation {-}

From visual inspection, the classification shows a strong confusion between the classes (see fig. \@ref(fig:rivercanalconfusionplot) as an example) in the river network data.

Text.

# Usage Notes {-}

Text.

# Code availability {-}

All processing and analysis was conducted with free open source software. All processing steps except for the download of the “EU-Hydro - River Network Database” (for practical reasons also referred to as river database) that was done manually are controlled and executed from within a targets pipeline in the programming language R [see fig. !!source]. Targets is an R package that provides a toolkit for reproducible workflows [!!source]. Spatial vector data such as the EU-Rivers are processed partly in R and a PostgreSQL (version 13) database with PostGIS (version 3.1.0) extension database for speed and memory reasons. For the same reason, all major raster calculations were conducted in a GRASS GIS (version 7.8.5-2) database. The database connections and all calculations in the databases are also controlled by this pipeline. For reaching a maximum of reproducibility, a docker container is provided to rerun all calculations easily. The R package renv is used for keeping track of the required R package versions and fits well to the combination with targets and docker to endure reproducibility.

# Acknowledgements {-}

Text.

# Author contributions statement {-}

Text.

# Competing interests {-}

Text. 

# Figures \& Tables {-}

```{r workflowfigure, echo=FALSE, out.width = "70%", fig.cap= "Workflow of the data processing in different software."}
include_graphics("diagramms/workflow_figure.pdf")
# include_graphics(tar_read(workflow_figure))
```

```{r studyareafigure, echo=FALSE, out.width = "80%", fig.cap= "Spatial coverage of this data set. The legend labels show the names according to the file name. If you want to more precisely check wether your study area or area of interest is covered by this dataset, please visit !!link to github readme."}
tar_read(studyarea_figure)
```

```{r projectdirtree, crop=TRUE, echo=FALSE, out.width = "70%", fig.cap="Directory tree of the project directory; only relevant subdirectories and files are listed here"}
include_graphics("diagramms/directory_tree.pdf")
```

```{r schematicmohp, echo=FALSE, out.width = "80%", fig.cap= "Schematic representation of MOHP measures using two examples for the stream orders one (A) and two (B)"}
include_graphics("diagramms/mohp_scheme.pdf")
```

```{r rivercanalconfusionplot, echo=FALSE, out.width = "80%", fig.cap= "Example of the river network data showing the confusion between the classes BH140 (river), BH020 (canal) and BH030 (ditch)."}
tar_read(river_canal_confusion_plot)
```

```{r dfddstatsbarplot, echo=FALSE, out.width = "80%", fig.cap= 'Distribution of classes BH140 (river), BH020 (canal) and BH030 (ditch) of the attribute column "DFDD".'}
tar_read(dfdd_stats_bar_plot)
```

```{r mainstemscheme, echo=FALSE, out.width = "80%", fig.cap= 'Schematic river network before (A) and after (B) merging linestring geometries by the added attribute column "levelpath_id".'}
include_graphics("diagramms/mainstem_scheme.pdf")
```

