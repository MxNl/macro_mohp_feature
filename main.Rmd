---
title: "Multiorder hydrologic Position for Europe --- a Set of Features for Machine Learning and Analysis in Hydrology"
author:
  - name: Maximilian Noelscher
    affiliation:
    - Federal Institute for Geosciences and Natural Resources (BGR), Berlin, Germany
abstract: |
  The presented dataset EU-MOHP v013.1.1 provides multiscale information on the hydrologic position (MOHP) of a geographic point within its respective river network and catchment as gridded maps with 30 m spatial resolution. More precisely, it comprises the three measures “divide to stream distance” (DSD) as sum of the distances to the nearest stream and catchment divide, “lateral position” (LP) as a relative measure of the position between the nearest stream and divide and “stream distance” (SD) as the distance to the nearest stream. These three measures are calculated for nine hydrologic orders to reflect different spatial scales from local to continental. Its spatial extent covers major parts of the European Economic Area (EEA39) which also largely coincides with physiographical Europe. Although there are multiple potential use cases, this dataset serves predominantly as valuable static environmental descriptor or predictor variable for hydrogeological and hydrological modelling such as mapping or forecasting tasks using machine learning. The generation of this dataset uses free open source software only and therefore can be transferred to other regions or input datasets.
output: 
  bookdown::pdf_document2:
    number_sections: TRUE
    template: scientific_data_template.tex
    keep_tex: yes
    fig_crop: TRUE
bibliography: 
  - eu-mohp.bib
urlcolor: black
linkcolor: black
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.align = 'center', fig.pos = "H", message = FALSE, warning = FALSE, fig.showtext = TRUE, size = "small", attr.output = ".numberLines", fig.path = "data_descriptor/tex/figure-", eval.after = "fig.cap")
options(tinytex.verbose = TRUE)

# Remove white space from pdf figures
knitr::knit_hooks$set(crop = knitr::hook_pdfcrop)

# knitr hook for code chunk font size
def.chunk.hook  <- knitr::knit_hooks$get("chunk")
knitr::knit_hooks$set(chunk = function(x, options) {
  x <- def.chunk.hook(x, options)
  ifelse(options$size != "normalsize", paste0("\n \\", options$size,"\n\n", x, "\n\n \\normalsize"), x)
})

library(knitr)
library(showtext)


library(targets)
source("R/constants.R")
library(assertr)
library(bibtex)
library(citr)
library(clipr)
library(data.table)
library(DBI)
library(dtplyr)
library(fs)
library(furrr)
library(ggridges)
library(glue)
library(here)
library(hues)
library(igraph)
library(janitor)
library(knitr)
library(lwgeom)
library(magick)
library(patchwork)
library(pdftools)
library(raster)
library(RefManageR)
library(renv)
library(rgdal)
library(rgeos)
library(rgrass7)
library(rmapshaper)
library(rmarkdown)
library(rnaturalearth)
library(rnaturalearthdata)
library(RPostgres)
library(sf)
library(sfheaders)
library(showtext)
library(stars)
library(styler)
library(tarchetypes)
library(tidyverse)
library(tmap)
source("R/import_functions.R")
source("R/preprocessing_functions.R")
source("R/database_functions.R")
source("R/postgis_functions.R")
source("R/grass_functions.R")
source("R/export_functions.R")
source("data_descriptor/targets/R/helper_functions.R")

source("data_descriptor/targets/R/visualization_functions.R")
source("data_descriptor/targets/R/eumohpclipr_functions.R")
source("data_descriptor/targets/R/constants.R")


# Add font for ggplots
font_add("Corbel", regular = "C:\\Windows\\Fonts\\corbel.ttf")

# source("../../R/constants.R")
```

<!--
```{r eval=FALSE, code=readLines("data_descriptor/targets/R/visualization_functions.R")}
 
```
-->

```{r, echo=FALSE, include=FALSE}
tar_read(directory_tree_trimmed)
```



# Background & Summary {-}

<!-- *[Background]* -->

<!-- as many as possible is not true I think, that leads to the curse of dimensionality. So it is important to chose only those who are also _very_ important. -->

In recent years, data science tools such as machine learning are increasingly applied to and specifically developed for hydro(geo)logical challenges and research questions \cite{zounemat-kermani_neurocomputing_2020,sit_comprehensive_2020}. In the field of hydrogeology, machine learning has been used successfully for groundwater level prediction and a variety of mapping tasks \cite{desimone_machine-learning_2020, knoll_large_2019, knoll_nation-wide_2020, muller_surrogate_2019, stackelberg_machine_2021, wang_comparison_2016, wunsch_forecasting_2018, wunsch_groundwater_2020, wunsch_deep_2022, wunsch_karst_2022}. Since machine learning models --- with the exception of hybrid- or physics-guided models --- are based purely on data without any knowledge of physical processes, it is important to provide meaningful features (also called predictor or explanatory variables) that affect the target variable so that the machine learning algorithm can model the function between input and target. For surface and near-surface processes, this criterion can be more or less fulfilled by the availability of remote sensing data, whereas for modelling sub-surface processes such as in hydrogeology, this poses a serious challenge.

<!-- *[Motivation/goals]* -->

The key motivation for this dataset is to partially close this gap by providing a set of features that introduce hydrological context to machine learning models regarding the horizontal position of a point within its catchment. The three measures --- determined by this horizontal position --- are calculated for several so-called hydrological orders. Hydrologic orders represent different spatial scales, from local to regional to continental. Therefore, the measures serve as proxies for geophysical characteristics of hydrologic systems at multiple scales and complements commonly available and used features such as land-use and land-cover, geological or soil maps.
This dataset is strongly inspired by Belitz et al. (2019)\cite{belitz_multiorder_2019} and adapts their ideas and methods to the “EU-Hydro - River Network Database”\cite{noauthor_eu-hydro_2021} but --- in contrast --- using free open-source software and a strong focus on reproducibility. This concept could be spatially further extended by applying the presented methods to global river network or hydrograph datasets, such as HYDRO1k\cite{lehner_new_2008} or MERIT Hydro-Vector\cite{lin_new_2021}. For more detailed background on the concept and methods, we refer to Belitz et al. (2019)\cite{belitz_multiorder_2019}. 

<!-- *[context of previous work and the literature]* -->

In their study, Belitz et al. (2019)\cite{belitz_multiorder_2019} also provide results from case studies to prove that the multiorder hydrologic position is a valuable feature when mapping diverse geophysical targets using machine learning. Its benefit to the performance of machine learning models has also been acknowledged by several other studies \cite{degnan_relation_2020, knierim_using_2020, stackelberg_machine_2021}.

<!-- *[potential reuse]* -->

The gridded maps of the EU-MOHP dataset\cite{nolscher_eu-mohp_2021-1} reflect a static geophysical attribute and can be used as features for machine learning or general modelling tasks in the field of hydrology and hydrogeology. As is generally the case in the geosciences, "static" in the sense of time-invariant is strongly relative, because river networks also change over time, but rather slowly compared to groundwater level fluctuations. This dataset can be applied at multiple spatial scales --- from local through regional to continental scales. Examples of use cases can be the mapping of hydrogeochemical parameters or hydraulic variables, the prediction of groundwater levels or catchment classification tasks using unsupervised machine learning methods. But it can also be used for exploratory data analysis.

<!-- *[schematic overview of the study and assay(s) design]* -->

The EU-MOHP v013.1.1 dataset\cite{nolscher_eu-mohp_2021-1} comprises the three measures

 - divide to stream distance (DSD),
 - lateral position (LP) and
 - stream distance (SD).

\noindent 
for each hydrologic order. This results in $n_{measures}\cdot n_{hydrologic\: orders} = `r length(FEATURE_NAMES)`\cdot`r tar_read(streamorders) %>% length()` = `r length(FEATURE_NAMES) * length(tar_read(streamorders))`$ different metrics to be used as features. Spatially, the dataset covers major parts of physiographical Europe and all of the 39 countries in the European Economic Area (EEA39). More precisely, it covers the `r tar_read(selected_studyarea) %>% nrow()` largest contiguous land masses of the EEA39 (Figure \@ref(fig:studyareafigure)).

<!-- ## EU-MOHP Concept -->

Conceptually, the three measures DSD, LP and SD of EU-MOHP\cite{nolscher_eu-mohp_2021-1} are based on the idea that the location in the hydrologic systems matters\cite{belitz_multiorder_2019}. A location can be e.g. close to the confluence of two large rivers or in another extreme be close to the catchment boundary of headwater streams. Such differences in the location in the hydrologic context contain valuable information for models as they determine a major part of the dynamics of the system, e.g. recharge, discharge, fluctuations or the temporal delay to input signals like meteorological forcings. The location or hydrologic position in this case refers to the position of a point between the nearest river and its catchment boundary. Thiessen divides are used as catchment boundaries instead of divides that are generated from digital elevation models (DEM) for a variety of practical reasons as described in Belitz et al. (2019)\cite{belitz_multiorder_2019}. For further details on Thiessen divides, see Methods.

Based on the river network and the Thiessen divides, the EU-MOHP\cite{nolscher_eu-mohp_2021-1} measures are calculated with

\begin{equation}
\text{DSD}_i = \text{DS}_i + \text{DD}_i (\#eq:eqdsd)
\end{equation}

\begin{equation}
\text{LP}_i = \frac{\text{DS}_i}{\text{DS}_i + \text{DD}_i} (\#eq:eqlp)
\end{equation}

\begin{equation}
\text{SD}_i = \text{DS}_i (\#eq:eqsd)
\end{equation}

\noindent
where $\text{DS}_i$ is the distance to the nearest stream, coast or surface water body of the hydrologic order $i$ and $\text{DD}_i$ is the distance to the nearest divide of the hydrologic order $i$. The terms "river" and "stream" are used here interchangeably, but stream refers more to the digitial representation of a river.

These three measures are not only calculated for a single scale, but are transferred to several scales through the second important part of the concept, the previously mentioned hydrological orders. This is particularly valuable because the importance of the various hydrological processes depends on the scale. It therefore allows both investigations at different scales and consideration of different depths, as the depth of groundwater flow paths generally increases with greater hydrological scale. The hydrologic orders are based on the stream orders of the river network. For a specific hydrologic order $i$, only streams with a stream order $>= i$ are used, whereas those with stream order $< i$ are removed (e.g. for hydrologic order 2, all streams with stream order 2, 3, 4 and greater are used; compare Figure \@ref(fig:schematicmohp)a and b). This can also be understood as a step-wise pruning of the smallest streams from the river network for each hydrologic order, which subsequently represent different spatial scales. Here, the stream orders are defined according to Strahler (1957)\cite{strahler_quantitative_1957} where all streams between the headwaters and the first confluence are assigned to the first stream order. The stream order downstream of a confluence increases by 1 if the upstream stream orders are equal. If the stream orders are not equal, it inherits the greater stream order of the confluent streams.

Figure \@ref(fig:datasetmapoverviewplot) shows the resulting EU-MOHP v013.1.1\cite{nolscher_eu-mohp_2021-1} exemplary for the `r length(HYDROLOGIC_ORDERS_TO_PLOT) %>% xfun::numbers_to_words()` hydrologic orders `r HYDROLOGIC_ORDERS_TO_PLOT %>% collapse_text()` as maps.

# Methods {-}

## Underlying Dataset {-}

The generation of this dataset is based on two datasets, first the “EU-Hydro -- River Network Database” version v013\cite{noauthor_eu-hydro_2021} and “EU-Hydro -- Coastline” version v013\cite{noauthor_eu-hydro_2021-1} with the advantage that data dependencies are low. From these two datasets, the four data layers 1) river network, 2) surface water bodies, 3) river basins/study area and 4) coastline were derived (see Table \@ref(tab:inputdata)). Due to this relatively low input data requirements, it is possible to transfer the presented methodology to other regions or datasets with only little effort.

The “EU-Hydro -- River Network Database”\cite{noauthor_eu-hydro_2021} as well as the “EU-Hydro -- Coastline”\cite{noauthor_eu-hydro_2021-1} has been manually downloaded from the Copernicus - Land Monitoring Service website (see Figure \@ref(fig:workflowfigure)a). The river network data is split into two GeoPackage (*.gpkg*) files for each of the `r targets::tar_read(river_networks_files) %>% length()` major river basins in the EEA39 countries, one with the naming scheme "*drainage\_network\_\<river name\>\_public\_beta\_v009.gpkg*" and the second with "*euhydro\_\<river name\>\_v011.gpkg*". The coastline data is stored in a single Shapefile (*.shp*) file (see Figure \@ref(fig:workflowfigure)b). All files have a total size of approximately 14 GB when unzipped.

The single *.shp* file containing the coastline has a size of 288 MB. For instructions on accessing this underlying data, see [Usage Notes].

## Processing {-}

The generation of the presented dataset requires several computationally expensive processing steps. For this reason and to make the methods more reproducible and maintainable, all processing steps are executed and controlled by a processing pipeline in the R programming language using the targets package (Figure \@ref(fig:workflowfigure)c)\cite{r_core_team_r_2020, landau_targets_2021}. This processing or targets pipeline can be seen as programming script tracking changes in the source code and the data with the major advantage among many that it can skip processing steps that are still up-to-date and re-executes those that need to be updated. Due to the large memory size requirements for this dataset as well as for computational speed reasons, a PostgreSQL database with the PostGIS extension is used for certain processing steps of vector data and a GRASS GIS database is used for all final raster-based calculations of the EU-MOHP\cite{nolscher_eu-mohp_2021-1} metrics (Figure \@ref(fig:workflowfigure)d and e). The calculations in the databases are also tracked and executed by the processing pipeline. In the following, the relevant steps of the methods are described. For a fully comprehensive description of all details, we refer to the source code itself (see [Code availability]).

## Data Preparation {-}

In the following, the most relevant processing steps are described. These steps are part of the previously described pipeline and are defined as so-called targets in the source code of the pipeline. To simplify the description, the processing steps are grouped here according to the previously mentioned data layers.

### Study Area {-}

The preprocessing steps to define and generate the study area are described first because it is required for the processing of all other data layers. The study area also defines the spatial coverage of the final product. For the generation of the study area, the layer *_eudem2_basins_h1* in the previously mentioned GeoPackage file with the naming scheme containing the suffix "*drainage\_network*" (see Table \@ref(tab:inputdata)) is used. It contains polygon geometries representing sub-basins of the major the river basins. Firstly, all polygon geometries belonging to European oversea territories such as the French islands in the Caribbean are removed. Then, the remaining  polygons are merged. Subsequently, out of these polygons of contiguous land masses the 10 largest polygons by area are chosen as study area.

### River Network {-}

The river or hydrographic network is based on the linestring geometries from the layer *River_Net_l* in the previously mentioned GeoPackage file with the naming scheme containing the suffix "*euhydro*" (see Table \@ref(tab:inputdata)). This data layer requires more processings steps than the other three data layers. Firstly, specific linestring geometries are removed from the river network. These linestrings comprise all geometries categorized as canal or ditch in the attribute column *dfdd* encoded with the values BH020 for canal and BH030 for ditch\cite{gallaun_eu-hydro_2019}. The are mainly removed because of the following two reasons. Firstly, many of the canal and ditch geometries have missing stream order values, which is required for the following processing steps and secondly, it is assumed that canals are often hydraulically disconnected to the natural hydrological system because of their impermeable side walls and canal bed. Besides this, the overall importance of canals and ditches is low when comparing their number of geometries to the number of river geometries (difference of three orders of magnitude). Furthermore, all linestring geometries categorized as non-perennial rivers in the attribute column *hyp* encoded with the values 2 (intermittent), 3 (ephemeral) and 4 (dry) are removed\cite{gallaun_eu-hydro_2019}. After this filtering, more than 1.05 million geometries remain. Then, missing and invalid stream order values are imputed with the value 1 as first stream order. This ensures that related geometries are at least included in the first hydrologic order. Subsequently, the river network geometries are clipped to the study area. 

The next very essential processing step implements a method to obtain linestring geometries that represent the mainstems of the river networks as described in the Supplementary of Belitz et. al. (2019). A mainstem is defined here as the longest path from the head water to the next most distant river mouth (see geometries with the same *levelpath_id* in Figure \@ref(fig:mainstemscheme)b). In Figure \@ref(fig:mainstemscheme)b the concept mainstems is schematically shown. In this figure, a mainstem consists of linestring geometries with the same *levelpath_id*. Belitz et al. (2019)\cite{belitz_multiorder_2019} made use of the column "LevelPathID" in their underlying NHDPlusV2 river network dataset\cite{nhdplusv2-dataset, dewald_nhdplus_2012}. As a comparable column does not exist in the “EU-Hydro -- River Network Database” dataset\cite{noauthor_eu-hydro_2021}, its generation is a required preprocessing step. This step is especially essential when applying these methods to river network data that does not provide suitable columns to generate the mainstems from. The generation of this required column *levelpath_id* for the river network dataset\cite{noauthor_eu-hydro_2021} involves the following steps. Firstly, a river network is derived separately for each hydrologic order by keeping only geometries with a stream order equal or greater than the specific hydrologic order as described in [Background & Summary] (see also Figure \@ref(fig:schematicmohp)). The following steps are repeated for each hydrologic order. The river network is sorted by the column *longpath* in descending order. The column *longpath* indicates the length of the path from the start node of a linestring geometry to the end node of the most downstream geometry of the river network. Then, starting with the top geometry, all line geometries are determined that are connected with each other by means of the columns *object_id* and *nextdownid*.The column *object_id* provides an unique ID for every linestring geometry and *nextdownid* indicates the *object_id* of the next downstream geometry. The now identified linestrings constitute the longest mainstem and are removed from the original river network. This is now iteratively repeated for the second top linestring in the remaining river network and so on.

Subsequently, the column *levelpath_id* is added as a unique ID for all geometries belonging to the same mainstem (Figure \@ref(fig:mainstemscheme)b). The geometries of the respective river network are then merged based on this column (see difference in linestring geometries between Figure \@ref(fig:mainstemscheme)b and c). This results in a river network for each hydrologic order separately with a reduced number of geometries as multiple geometries are now summarised into mainstems.

The next step addresses the occurrence of flow splits in the river network. A flow split or divergence is defined here as junction of linestring geometries with more than one linestring geometry representing out-flowing streams (orange marks in Figure \@ref(fig:divergencescheme)). To transfer the methods from Belitz et al. (2019)\cite{belitz_multiorder_2019} for the calculation of EU-MOHP\cite{nolscher_eu-mohp_2021-1}, it is required to remove minor flow paths that originate from such divergences from the river network. A classification of linestring geometries into major and minor flow paths is not directly provided by any column in the underlying river network dataset. Belitz et al. (2019)\cite{belitz_multiorder_2019} used the column *divergence* for removing all minor flow paths. In order to reproduce this removal of minor paths, all linestring geometries that intersect other linestrings with both the end and start node. The removal of these minor flow paths is not done for the first hydrologic order to include all linestrings in at least one order. The implementation of these steps pointed out errors in the river network dataset\cite{noauthor_eu-hydro_2021} These errors are related to errors of values in the columns *longpath* and *nextdownid*. Based on visual inspection, they occur in the french river networks of Garonne, Loire and Seine and are corrected programmatically during processing.

Then, the river networks are sorted by the length of the linestring geometries in descending order and provided with an unique ID for each geometry in the column *feature_id* (see *feature_id* in Figure \@ref(fig:mainstemscheme)c).


### Surface Water Bodies {-}

The surface water bodies are derived from the layer *InlandWater* in the GeoPackage file with the naming scheme containing the suffix "*euhydro*" (see Table \@ref(tab:inputdata)). A filter is applied to retain only the geometries of surface water bodies that have an area greater than four times the area of the grid cell. Another filter is applied to remove all geometries that do not intersect with the river network geometries. Since the river networks of the 9 hydrologic orders differ from each other, this second filter is applied individually for each of the river networks. This results in a dataset of surface water bodies for each hydrologic order.


### Coastline {-}

The data layer coastline is derived from the Shape file related to the “EU-Hydro -- Coastline” dataset\cite{noauthor_eu-hydro_2021-1} (see Table \@ref(tab:inputdata)). Like rivers, the ocean, defined by the coastline, is an area where water accumulates and therefore its spatial representation is necessary for the generation of this dataset.\cite{belitz_multiorder_2019}.  
Firstly, the polygon geometries of the underlying Shape file are merged. A buffer of 3000 m is added to the merged geometries. This is necessary to ensure that the outline of the study area is intersects with the coastline polygon geometries for the next step. Without this buffer, discrepancies between the study area and the coastline can be noticed. These discrepancies would lead to undesired results after the next step. The value of 3000 m is derived from visual inspection. The resulting multipolygon geometries are intersected with the outline of the study area to obtain the coastline as linestring. Those parts of the study area that do not intersect with the polygon geometries are categorized as "administrative borders over land". This intersection then ensures that the coastline exactly aligns with the study area outline. The resulting coastline is shown in Figure \@ref(fig:coastlineplot). The coastline is then added to each river network of all hydrologic orders.

## EU-MOHP {-}

After obtaining all four required data layers as described previously, the next and last processing step comprises multiple smaller steps with the final goal to calculate and export the EU-MOHP\cite{nolscher_eu-mohp_2021-1} metrics. Because the processing is analogous for all hydrologic orders and all of the 10 polygon geometries of the study area, this step is described only once in general terms. As all processing steps described below require grid based computations, a GRASS GIS database is used (see Figure \@ref(fig:workflowfigure)e).

The four data layers study area, river network including the coastline and surface water bodies of the respective hydrologic order and the coastline are written into the GRASS GIS database. The projection of the GRASS GIS database is set to the ETRS89 Lambert Azimuthal Equal-Area projection coordinate reference system (EPSG: 3035). The spatial resolution of the raster cells is set to 30 m.

### Thiessen Catchments and Distance to Stream (DS) {-}

As described in [Background & Summary], the catchment boundaries are required to determine DD (see Eq. \@ref(eq:eqdsd) and \@ref(eq:eqlp) or Figure \@ref(fig:schematicmohp)). Therefore, Thiessen divides are used. A Thiessen divide is the outline of a Thiessen catchment which in turn is the area containing all points in a river network to which a river is closer than any other river \cite{johnston_evaluation_2009}. One major advantage is that Thiessen divides can be calculated purely based on the river network itself while avoiding issues such as closed lows in the resulting metrics \cite{belitz_multiorder_2019}. This advantage outweighs the numerous minor problems associated with DEM-based catchments, especially when taking into account the uncertain correspondence of the subsurface catchment to the surface catchment. A detailed discussion on the preference of Thiessen divides over topographic divides is provided in Belitz et. al. (2019), section 2.2. \cite{belitz_multiorder_2019}.
In order to obtain Thiessen divides, the first step is to calculate the euclidean distance from each raster cell center to the nearest river network geometry. The resulting distances correspond to DS in Eq. \@ref(eq:eqlp), \@ref(eq:eqdsd) and \@ref(eq:eqsd) or Figure \@ref(fig:schematicmohp)). This step also determines the feature ID of the nearest geometry for all raster cells. Then, the polygons representing Thiessen catchments are derived by merging all raster cells that are assigned to the same feature ID. Finally, the outlines of these polygons are used as Thiessen divides. 

### Distance to Divide (DD) {-}

To obtain the distance to divide (DD) for each raster cell, the distances from each raster cell center to the nearest Thiessen divide is calculated. But the determination of the nearest Thiessen divide can not be achieved by a simple nearest neighbour search as it is used for the calculation of DS and the feature ID of the nearest river. In order to implement the physical reality that in catchments the water accumulates and runs off in rivers, an additional condition is required. This condition has to ensure that distances to the nearest divide are not calculated across rivers. In other words the nearest Thiessen divide for each raster cell must not lie on the other side of the river. In other words, when drawing a imaginary line between the nearest Thiessen divide and the grid cell center, this line must not cross a river geometry (see black line versus red line in \@ref(fig:ddinaccuracies)). Without this condition the geometric center line of the Thiessen catchments would be considered as areas of accumulation and discharge. To meet this condition, the GRASS GIS command "r.walk" was used. Minor inaccuracies regarding this command for the described purpose are noted in Technical Validation. The calculated distances correspond to DD in Eq. \@ref(eq:eqlp), \@ref(eq:eqdsd) and \@ref(eq:eqsd) or Figure \@ref(fig:schematicmohp).

### Measures DSD, LP and SD {-}

Based on the two calculated raster layers containing the distances DS and DD, the three EU-MOHP measures DSD, LP and SD are now calculated by the application of the equations Eq. \@ref(eq:eqdsd), \@ref(eq:eqlp) and \@ref(eq:eqsd) and the GRASS GIS raster map calculator ("r.mapcalc"). In order to reduce the storage size, the raster values of the measure LP are multiplied by a factor of 10,000 and rounded to be able to store them as integer values with two decimal digits. The two measures DSD and LP are rounded to the nearest integer. Finally, the resulting raster layers for LP, DSD and SD are exported from the GRASS GIS database and stored on disk as GeoTIFF files with *.tif* file extension.

## Data Descriptor {-}

To enhance the reproducibility of the data descriptor manuscript itself, it is generated as part of the processing pipeline. Also all tables and all data derived figures are created from within the pipeline. This ensures that all figures are up-to-date and reflect the most recent state of the methods. The descriptor is written in RMarkdown from which a LaTeX and a PDF file are generated using the *knitr* package\cite{allaire_rmarkdown_2021, stodden_knitr_2014}.
  
# Data Records {-}

The presented EU-MOHP v013.1.1 dataset\cite{nolscher_eu-mohp_2021-1} is available on the Hydroshare repository at [https://doi.org/10.4211/hs.0d6999591fb048cab5ab71fcb690eadb](https://doi.org/10.4211/hs.0d6999591fb048cab5ab71fcb690eadb). The dataset represents gridded spatial maps and is divided into multiple GeoTIFF files with a *.tif* file extension. Each file represents data on one of the three EU-MOHP\cite{nolscher_eu-mohp_2021-1} measures -- LP, DSD, and SD -- for one hydrologic order for a different study area polygon (spatial coverage). The file names are structured according to the file naming scheme "*mohp_europe_\<region name for spatial coverage\>\_\<abbreviation of the EU-MOHP measure\>\_\<hydrologic order\>\_\<spatial resolution\>.tif*". The placeholders including "*<*" and "*>*" can be theoretically replaced by any combination of the values summarized in Table \@ref(tab:outputdata). But not all study area polygons have a river network for each hydrologic order. For example, the study area polygon for the island of Sardinia only has rivers up to a maximum streamorder of 6 and therefore only a maximum hydrologic order of 6. This means that there are no GeoTIFF files for Sardinia for hydrologic orders 7 - 9. Therefore, the total number of files is $n_{measures}\cdot \sum_{i = 1}^{n_{hydrologic\: orders}} n_{study\: area\: polygons,\: i} = `r length(FEATURE_NAMES)`\cdot \sum_{i = 1}^{`r length(tar_read(streamorders))`} n_{study\: area\: polygons,\: i} = `r list.files("output_data/stream_distance", "*.tif") %>% length() * length(FEATURE_NAMES)`$.

The GeoTIFF files derived in section [Measures DSD, LP and SD], were uploaded to Hydroshare as separately compressed files with the file extension *.7z* using the free and open-source file archiver program 7-Zip. Each *.7z* file corresponds to one *.tif* file.

On Hydroshare you have the option to either select all *.7z* files and download them as a zipped bagit archive or download a custom selection of files if your are only interested in a specific region (area of interest) or specific hydrologic orders. For creating a user defined selection you can use the search bar to filter the files for a spatial coverage or a hydrologic order as described on Hydroshare website of this dataset. If you want to check more precisely whether your area of interest is covered by this dataset at all or which files are relevant, please see the interactive map on Github
([https://mxnl.github.io/macro_mohp_feature/](https://mxnl.github.io/macro_mohp_feature/)).

The presented EU-MOHP dataset\cite{nolscher_eu-mohp_2021-1} has version v013.1.1 The version is generated as a composition of the “EU-Hydro -- River Network Database”\cite{noauthor_eu-hydro_2021} version (v013) and a major and a minor version number (1.0) that are related to the methods of this dataset.

# Technical Validation {-}

## Statistical summary {-}

The EU-MOHP dataset\cite{nolscher_eu-mohp_2021-1} consists of calculated values based on a hydrological concept and therefore cannot be validated by observations or measurements. As a first approximation, a statistical summary based on a sample of every 100th grid cell per row and column is used for validation. Table \@ref(tab:statstabledata) provides the median, mean, minimum and maximum value of the three measures across all hydrologic orders. In accordance with the theoretical background, the values of mean, median and max of DSD and SD are increasing with increasing hydrologic order (see also Figure \@ref(fig:datasetmapoverviewplot)a1-3 and c1-3). This also highlights the different spatial scales. This increase is not shown by median or mean values of LP due to the fact that LP is a relative measure. The minimum and maximum values of LP are 0 and 1 as expected across all hydrologic orders. The only anomaly here are the median and mean related to the ninth hydrologic order. These lower values compared to all other hydrologic orders are related to the spatially highly unequal distribution of the river network in this case in combination with the shape of the coastline of Europe. This will be discussed in next paragraph. Another anomaly are the minimum values of DSD at higher hydrologic orders. Their deviation from 0 is caused by the decreasing probability that a grid cell center lies exactly on the intersection of a river and divide at higher hydrologic order.

For a more comprehensive overview of the distribution of the values of the three measures, Figure \@ref(fig:statsridgeplot) shows the density of the values for all hydrologic orders. Here, the overall increase of the values of DSD and SD with increasing hydrologic order as previously seen in the Table \@ref(tab:statstabledata) is clearly apparent. Further, the distribution of DSD values changes from a left-skewed uni-modal distribution (1st hydrologic order) to a multi-modal distribution (9th hydrologic order). This change of mode is caused by the shape of the European coastline. Its shape has many peninsulas of different sizes. Examples for such peninsulas ordered from smaller to bigger are Denmark, Bretagne, Greece, Italy and the Iberian Peninsula. With increasing hydrologic order the number of rivers in these peninsulas reduces. If there is no river present anymore, the distribution of DSD show a peak at values related to this peninsula. Belitz et al. (2019)\cite{belitz_multiorder_2019} referred to this effect as peninsula effect. This also explains the evident change of the distribution of LP of the 9th hydrologic order compared to all other orders.

This effect is most pronounced in the 9th hydrologic order, where the last few hundred kilometers of the Danube river before its river mouth into the Black Sea is the only river segment in the whole of continental Europe (Figure \@ref(fig:datasetmaphydrologicorder9plot)). The utilization of this dataset at locations with such an effect is very limited or not meaningful at all.

## Cross-comparison with original MOHP methods {-}

To further assess the quality of the applied methodology in this study, a cross-comparison with the original MOHP dataset for the contiguous US by Belitz et al. (2019) was performed. Therefore, we reproduced parts of the original MOHP dataset by applying our methodology to the NHDPlusV2 dataset\cite{nhdplusv2-dataset}, which is the underlying dataset of the original MOHP dataset, and compared these reproduced results to the original dataset\cite{belitz_multiorder_2019}. As the methodology is analogous for all hydrologic orders and the values of all three measures (DSD, LP and SD) have the same dependencies (DD and DS), it is sufficient to cross-compare LP for a single hydrologic order. For visual purposes, the 7^th^ hydrologic order was selected. Accordingly, the reproduced dataset will be referred to as "Reproduced LP7" and the original as "Original LP7". Figure \@ref(fig:comparisondifferencepatchwork) shows a side-by-side comparison between the Original LP7 (a) and Reproduced LP7 (b). From visual inspection, the major patterns appear very similar on both maps. Differences can be mainly observed in proximity to the administrative borders to Canada and Mexico. These difference among some other minor ones are due to partly deviating reproduction from the original methodology. Although, the methodology of the original MOHP dataset\cite{belitz_multiorder_2019}  is generally well described, it was not possible to fully comprehend and reproduce all steps due to the source code not being publicly available. For this reason, the coastline used for the cross-comparison is not fully identical to the coastline used for the original dataset. For the same reason, surface water bodies are not included in the reproduced dataset. In addition, river networks from the two neighboring countries Canada and Mexico were not incorporated. The regions most affect by these differences will be later excluded in the quantitative cross-comparison.
Figure \@ref(fig:comparisondifferencepatchwork)c shows the absolute difference between both maps from Figures \@ref(fig:comparisondifferencepatchwork)a and b defined as 

\begin{equation}
\text{Absolute difference} = \frac{\text{Original LP7} - \text{Reproduced LP7}}{10,000}. (\#eq:eqreldif)
\end{equation}

The division by 10,000 is applied to rescale the values to a range from 0 to 1. In this figure, the previously described differences along the borders and close to surface water bodies become more visible. This Figure also shows that the values of the absolute difference is predominantly close to 0 (greyish colour) across all of contiguous US indicating no or small differences.
In addition to this visual comparison, a quantitative cross-comparison is performed by comparing the raster cell values of the Original LP7 and the Reproduced LP7 at 10,000 randomly distributed points. To account for these expected discrepancies between the reproduced and original datasets near the coast and at administrative boundaries over land, a negative buffer of 300 miles (about 480 km) inland was used to exclude these regions from the quantitative cross-comparison. Figure \@ref(fig:accuracypatchwork)a schematically shows the sampling strategy including the location of half of all 10,000 sampling points.

Figure \@ref(fig:accuracypatchwork)b shows the raster cell values of the Original LP7 and the Reproduced LP7 at the sampling locations. Whereas only a small proportion of all points is located more distant to the dashed diagonal line, indicating an ideal reproduction of the Original LP7, the vast majority lies close to that line. To quantify this, a linear regression model was applied to all points. The $R^2$ of the fitted model is 0.987. In summary, the cross-comparison shows a very good agreement of the methodology used in this study with the described methods in Belitz et al. (2019). The largest differences in the results can be explained by deviations in the reproduced methodology, as already mentioned (river networks in neighbouring countries, surface water bodies).

## Underlying river network Dataset {-}

As the generation of this dataset is based on the “EU-Hydro -- River Network Database”, its accuracy and validity depends strongly on the quality of this underlying dataset. The “EU-Hydro -- River Network Database”\cite{noauthor_eu-hydro_2021} has been generated through a combination of photo interpretation of very high resolution imagery and drainage modelling based on the EU DEM with 25 m resolution. It comprises a river network for all of the EEA39 states at a high resolution. According to our research, there is no comprehensive quality assessment or validation of the version used. The visual inspection reveals some errors relevant to the methodology presented here. Firstly, a confusion of the classification of the linestring geometries into canals, ditches and rivers occurs frequently. An example for such confusion is shown in Figure \@ref(fig:rivercanalconfusionplot). Here, some relatively straight shaped linestring geometries are classified as river (value BH140 in column *dfdd*), whereas meandering geometries are classified as canal (value BH020 in column *dfdd*). Other errors might be introduced through the limitation of the spatial resolution of the photo imagery and the EU DEM. This potentially affects the detection and of smaller rivers, canals and ditches.

As previously mentioned in [River Network], additional errors were found in the river network data. These errors relate to incorrect values in the *longpath* and *object_id* columns and are corrected in places where the resulting maps revealed incorrect patterns by visual inspection. These patterns were evident from the lack of a river network in larger regions. It is very likely that more errors of such type will remain in the river network with minor impact on the resulting maps. Fixing these errors programmatically requires a solid theoretical knowledge of processing networks and could be done in future versions of the "EU-Hydro - River Network Database"\cite{noauthor_eu-hydro_2021}.

## Administrative Borders Over Land {-}

The accuracy of this dataset may also be reduced near the boundaries that run over land rather than along the coast or river basin boundaries. This includes the regions that are close to the borders in the South and East of Turkey, in the East of continental Europe and in the East of Finland (see yellowish lines in Figure \@ref(fig:coastlineplot)). Here, the boundaries of the underlying dataset, and thus this dataset, follow administrative borders instead of river basin boundaries Therefore, calculated distances to the nearest stream in these regions may be inaccurate because another stream not included in the dataset could be closer to a raster cell center. The width of these potentially inaccurate regions along the margins increases with hydrologic order. Because the stream locations of adjacent stream networks are unknown, it is not possible to delineate this region or quantify its width. To address this issue when applying this dataset to such a region, a conservative option would be to truncate or mask these regions by shifting the corresponding boundaries inward by the maximum value in the stream distance map of the respective hydrologic order.

## Calculation of DD {-}

Another inaccuracy is introduced by the method to calculate DD. This inaccuracy only affects a narrow area near headwaters. To calculate DD, the GRASS GIS command `r.walk` is used. The command `r.walk` originally aims at a different purpose than the one it is used for here. It calculates the cumulative costs for moving between two geographic locations based on topographic map and a map that represents friction costs. Because of the applied setting of the command parameters, it calculates the horizontal distance from a cell to the nearest Thiessen divide while preferring a path without crossing a stream. This behavior is usually achieved everywhere except for areas near headwaters where "walking" around the stream becomes an option. To illustrate this, following case is considered. If a linestring geometry representing a stream is closer to one side of the Thiessen divide than to the other side, `r.walk` calculates an incorrect distance around the start of the linestring as it cheaper to "walk" around the stream than walking a straight path from the more distant but correct side of the Thiessen divide. Thus, the straight path from this mistakenly nearest side of the Thiessen divide crosses the stream. Whereas the required and correct behaviour would be to calculate the distance as the length of a straight line to the Thiessen divide that does not cross the stream (Figure \@ref(fig:ddinaccuracies)).

## Surface Water Bodies in DSD Maps {-}

The method for calculating DD also causes missing values (NA) for grid cells that are located inside larger surface water bodies such as lakes. This issue only affects the measure DSD or its related raster maps ("*\<abbreviation of the EU-MOHP measure\> = dsd*"). If required, a potential solution to this could be to fill these NA cells with values from the nearest non-NA grid cell as a simple approximation.

As stated below, we encourage readers and users of this dataset to report errors in the methods or code in the mentioned Github repository.

# Usage Notes {-}

This data publication mainly provides two resources to be used by the research community. Firstly, the dataset itself and secondly, the source code to be adapted and applied to custom river network data. The former can be used as additional, hydrological context describing features in any machine learning or non-machine-learning-based modelling task in the domain of hydrology and hydrogeology across several scales. After downloading the required compressed *.7z*-files from Hydroshare (see [Data Records] for download link), they can be decompressed using the free and open-source file archiver program 7-Zip. Due to the widely used GeoTIFF file format, the dataset can be processed and visualized through any GIS Software. For reasons of reproducibility in science, it is recommended to use programming languages instead of point-and-click software such as ArcGIS or QGIS. The programming languages R or Python provide a variety of tools to import, process and visualize GeoTIFF data but also offer flexibility from a machine learning perspective. The R packages *raster* and *stars* cover most common operations on raster data \cite{hijmans_raster_2020, pebesma_stars_2021}. To crop the GeoTIFF files to your custom study area or area of interest, the function `st_crop()` from the *stars* package offers a fast cropping without having to read the large GeoTIFF files into memory. To do so, it's required to read in the GeoTIFF files as *stars_proxy* objects with `read_stars(<path to GeoTIFF file>, proxy = TRUE)` before applying `st_crop()`. To simplify some of the previous steps, we developed the R package *eumohpclipr* ([https://github.com/MxNl/eumohpclipr/](https://github.com/MxNl/eumohpclipr/))\cite{noelscher_eumohpclipr}. This package provides functionality to mosaic, crop or clip and plot the EU-MOHP dataset\cite{nolscher_eu-mohp_2021-1}. For a fast raster cell value extraction based on polygons, the R package *exactextractr* ([https://github.com/isciences/exactextractr](https://github.com/isciences/exactextractr))\cite{baston_exactextractor} is recommended.

It is important to note that raster cell values of all GeoTIFF files are stored as integers in the *INT32* data type to reduce storage size. Cell values of files that represent LP ("*\<abbreviation of the EU-MOHP measure\> = lp*") must be divided by 100 to obtain percentages with two decimal digits or by 10,000 to obtain values in the range from 0 to 1. The cell values of all other files represent a distance in meters and can be used as is. All files are stored using the coordinate reference system (CRS) ETRS89-extended / LAEA Europe with the EPSG code `r CRS_REFERENCE`.

The following paragraphs focus on the usage of the source code for reproducing the EU-MOHP dataset\cite{nolscher_eu-mohp_2021-1} and to use it for other custom datasets. They also provide information on the hardware and software setup as well as on major steps before getting the source code to to run.

The computations to generate the presented dataset\cite{nolscher_eu-mohp_2021-1} were performed on a DELL PowerEdge C4140 Server with an Intel Xeon Gold 6240R CPU and 384 GB installed RAM. The installed operation system is Microsoft Windows Server 2019 Standard, version 10.0.17763 Build 17763. The total runtime of the pipeline as well as of individual targets is summarised in Table \@ref(tab:runtime).

The used software comprises R (version `r str_c(R.Version()$major, ".", R.Version()$minor)`)\cite{r_core_team_r_2020}, PostgreSQL (version 13) database with the PostGIS (version 3.1.0) extension and GRASS GIS (version 7.8.5-2). R package dependencies are managed with the *renv* package\cite{ushey_renv_2021}. The versions of used R packages can be found in the *renv.lock* file. Most used R packages are also listed in the references\cite{landau_targets_2021, wickham_welcome_2019, allaire_rmarkdown_2021, pebesma_simple_2018, fischetti_assertr_2021, r_special_interest_group_on_databases_r-sig-db_dbi_2021, winston_chang_extrafont_2014, vaughan_furrr_2021, hester_glue_2020, muller_here_2020, csardi_igraph_2006, firke_janitor_2021, pedersen_patchwork_2020, hijmans_raster_2020, bivand_rgdal_2021, bivand_rgrass7_2021, south_rnaturalearth_2017, wickham_rpostgres_2021, cooley_sfheaders_2020, qiu_showtext_2021, pebesma_stars_2021, walthert_styler_2021, landau_tarchetypes_2021, ushey_renv_2021, stodden_knitr_2014}.

The directory and file structure of the project folder containing all code and files to generate this dataset is summarized in Figure \@ref(fig:projectdirtree) in a tree structure. Files and directories that are not relevant for describing the methods are not shown here. The project folder as the top level directory is the working directory. The file *config.yml* (line `r dirtree_lineno("config.yml")`) contains definitions of variables that are meant to be set by a user before running the targets pipeline. The most relevant variable is *cellsize* which sets the spatial resolution of the resulting EU-MOHP gridded maps\cite{nolscher_eu-mohp_2021-1}. Another important variable is *area* to switch between a test study area and the complete study area for all EEA39. The test study area represents a small fraction of the study area. This reduces the runtime of the pipeline for testing purposes. The folder *grassdata* (line `r dirtree_lineno("grassdata")`) is used for writing the GRASS GIS databases to. The folder *input_data* (line `r dirtree_lineno("input_data")`) contains all required input data. Firstly, the sub-folder *data* (line `r dirtree_lineno("data")`) comprises the river network data as one single folder per basin as it is derived after unzipping the downloaded “EU-Hydro -- River Network Database” data\cite{noauthor_eu-hydro_2021} (see [Underlying Dataset]). The second sub-folder *EUHYDRO_Coastline_EEA39_v013* (line `r dirtree_lineno("EUHYDRO_Coastline_EEA39_v013")`) contains the coastline data (see [Underlying Dataset]). The third sub-folder *studyarea_test* (line `r dirtree_lineno("studyarea_test")`) contains a test study area as Shape file for pipeline testing purposes only (see [Code availability]). Lastly, the sub-folder *validation* contains all data required to calculate the values and figures for the cross-comparison in Technical Validation.
The file *macro_mohp_feature.Rproj* (line `r dirtree_lineno("macro_mohp_feature.Rproj")`) is the R project file. The folder *output_data* (line `r dirtree_lineno("output_data")`) contains three sub-directories where the final EU-MOHP gridded maps\cite{nolscher_eu-mohp_2021-1} are written to. These directories are created by the pipeline if they don't already exist. *R* (line `r dirtree_lineno("R")`) contains R scripts where custom functions and constants are defined. *renv* (line `r dirtree_lineno("renv")`) and the file *renv.lock* (line `r dirtree_lineno("renv.lock")`) are related to the R package renv that tracks versions of package dependencies \cite{ushey_renv_2021}. The R script *run_pipeline.R* (line `r dirtree_lineno("run_pipeline.R")`) contains code to execute the targets pipeline that does all the data processing and calculations. *targets* (line `r dirtree_lineno("targets")`) contains the definition of all targets or processing steps of the pipeline. For overview reasons, it is split thematically across multiple files. *\_targets* (line `r dirtree_lineno("_targets")`) is used by the targets package internally. The file *\_targets.R* (line `r dirtree_lineno("_targets.R")`) sets up the targets pipeline and loads all dependencies.

To reproduce this dataset, the subsequent steps are required. They have been tested under Windows as operating system (see above in this section), therefore deviations under Linux or MacOS are likely:

1.  Install the R language, PostgreSQL, PostGIS and GRASS GIS in their previously described versions. Furthermore, install the latest version of RStudio. RStudio is a free integrated development environment for R.
 
2.  Set up a PostgreSQL database with the name "postgis" or, alternatively, choose a different name and change the variable *database_name* in the *config.yml* file later. Independently from the database name, change the setting of the PostgreSQL database to not request a password for connection.

3.  Download the project repository containing all required code and scripts from the above mentioned static code repository.
 
4.  Download the required input data “EU-Hydro -- River Network Database”\cite{noauthor_eu-hydro_2021} and “EU-Hydro -- Coastline”\cite{noauthor_eu-hydro_2021-1} from the links below and store it in the directory *input_data* as described previously to make it match the file structure of the *input_data* (Figure \@ref(fig:projectdirtree), line `r dirtree_lineno("input_data")` - `r dirtree_lineno("studyarea_test")`). For downloading the data a free user account is required. Alternatively, if you want to keep the data at another directory, e.g. on a remote server, you need to change the file paths in the file *constants.R*.
 
5.  Navigate to the project directory and open the file *macro_mohp_feature.Rproj* with RStudio.

6.  Install the package *renv* by running following command in the console
```{r, eval=FALSE}
install.packages("renv")
```
 
7.  Install all package dependencies with the subsequent line (Note that under Linux and MacOS some R-packages have system dependencies, such as the package _sf_, which depends on `libgeos-dev`, among others. Please consult the respective documentation when facing an issue.)
```{r, eval=FALSE}
renv::restore()
```

8.  Before running the pipeline on the full spatial coverage of the EEA39 countries, we recommend to test the pipeline with the smaller test study area by setting the variable *area* in the file *config.yml* to "test". The runtime will be around 20 min. The content of the *config.yml* should look like this (Note the empty line in line 6):
```{r, eval=FALSE}
area: test
cellsize: 30
database_name: postgis
exclude_scandinavian_basins: FALSE
simplify_polygons: FALSE
data_descriptor_only: FALSE
parallel: TRUE

```
If the pipeline works in "test" mode, you can change the variable *area* back to "europe".

9.  Start the processing pipeline by running the file *run_pipeline.R* with
```{r, eval=FALSE}
source("run_pipeline.R")
```

10.  If you encounter any problems, please contact the corresponding author or preferably open a Github issue. Errors can probably be caused by incorrect directories and file paths. If the available memory is insufficient, one option is to run the pipeline sequentially rather than in parallel. To do this, change the variable *parallel* in the file *config.yml* from `TRUE` to `FALSE`.

11.  To reproduce the data descriptor itself, you can execute the pipeline after a successful run by setting the variable *data_descriptor_only* in the file *config.yml* to "TRUE".

The required underlying datasets “EU-Hydro -- River Network Database”\cite{noauthor_eu-hydro_2021} version v013 can be downloaded from the Copernicus Land Monitoring Service ([https://land.copernicus.eu/imagery-in-situ/eu-hydro/eu-hydro-river-network-database?tab=download](https://land.copernicus.eu/imagery-in-situ/eu-hydro/eu-hydro-river-network-database?tab=download)) as well as the “EU-Hydro -- Coastline”\cite{noauthor_eu-hydro_2021-1} version v013 ([https://land.copernicus.eu/imagery-in-situ/eu-hydro/eu-hydro-coastline?tab=download](https://land.copernicus.eu/imagery-in-situ/eu-hydro/eu-hydro-coastline?tab=download)).
In order to maximize and simplify reproducibility, we currently plan to set up a docker container. For availability updates, please visit the mentioned Github repository.
For transferring the presented methods to another custom region, equivalent input data to Table \@ref(tab:inputdata) is required.

# Code availability {-}

As stated previously, all processing steps including the generation of the dataset, most of the figures and the manuscript are script based. All required source code\cite{nolscher_eu-mohp_2021} can be found on Hydroshare ([https://doi.org/10.4211/hs.8ea376970c904c6698fc8cfe392689de](https://doi.org/10.4211/hs.8ea376970c904c6698fc8cfe392689de)) as a static code repository. Due to the procedure of the reviewing process, this static code repository only contains the status of the code before the last reviewing iteration. The final code used for submitting the reviewed manuscript can be found in this separate code release on Github ([https://github.com/MxNl/macro_mohp_feature/releases/tag/v013.1.1.0](https://github.com/MxNl/macro_mohp_feature/releases/tag/v013.1.1.0)).
The actively developed code can be also found in the same repository on Github ([https://github.com/MxNl/macro_mohp_feature](https://github.com/MxNl/macro_mohp_feature)). We encourage interested users of this dataset to report errors in the code or to give hints on further methodological or programming improvements through opening an issue in the Github repository or contacting the corresponding author via E-mail.

# Acknowledgements {-}

The generation of this dataset would not have been possible without all the free open-source packages for R. Therefore, a special thanks goes to their developers, especially to Will Landau who quickly provided answers and solutions regarding the *targets* package. All used packages can be found in the references. We were also grateful for discussions and hints by our colleagues at BGR. We also thank the three reviewing colleagues. Their consistently constructive comments really helped improving the data descriptor.

# Author contributions statement {-}

M.N. was involved in all phases and steps of the generation of this dataset including investigations and visualizations. M.M. contributed to software development in R and PostGIS and set up the docker container. M.M. also contributed to the methodology and validation. S.B. contributed to the conceptualization of the dataset, but also led the supervision, project administration and funding acquisition. All authors reviewed and edited the manuscript.

# Competing interests {-}

The authors declare no competing interests, financial or non-financial, related to the presented dataset, its generation or data descriptor.

\FloatBarrier

# Figures \& Tables {-}

\FloatBarrier

```{r studyareafigure, echo=FALSE, out.width = "75%", fig.showtext = TRUE, fig.cap= "Spatial coverage of the dataset which is determined by the study area data layer."}
tar_read(studyarea_figure)
```

```{r schematicmohp, echo=FALSE, out.width = "100%", fig.cap= "Schematic representation of MOHP measures using two examples for the hydrologic orders 1 (a) and 2 (b). DS is the horizontal distance to the nearest stream and DD is the horizontal distance to the nearest Thiessen divide under the condition that the divide is on the same side of the stream as the raster cell center (black point)."}
include_graphics("data_descriptor/tex/mohp_scheme.pdf")
```

```{r datasetmapoverviewplot, echo=FALSE, out.width = "100%", fig.height=7, fig.showtext = TRUE, fig.cap= str_glue("Resulting maps of the three EU-MOHP measures DSD (a), LP (b), and SD (c) in the columns exemplary for the three hydrologic orders {HYDROLOGIC_ORDERS_TO_PLOT[1]} (1), {HYDROLOGIC_ORDERS_TO_PLOT[2]} (2) and {HYDROLOGIC_ORDERS_TO_PLOT[3]} (3) in the rows. Note that the breaks of the binned colour scale is based on quantiles.")}
tar_read(dataset_map_overview_plot)
```

```{r workflowfigure, echo=FALSE, out.width = "70%", fig.cap= "Workflow of the data processing in different software."}
include_graphics("data_descriptor/tex/workflow_figure.pdf")
```

```{r mainstemscheme, echo=FALSE, out.width = "100%", fig.showtext = TRUE, fig.cap= knitr:::escape_latex("Schematic representation of the river network and its linestring geometries before generating the mainstems (a), after the identification of mainstems including the column levelpath_id (b) and after merging the linestring geometries by column levelpath_id and adding a feature_id column (c).")}
include_graphics("data_descriptor/tex/mainstem_scheme.pdf")
```

```{r divergencescheme, echo=FALSE, out.width = "70%", fig.showtext = TRUE, fig.cap= knitr:::escape_latex('Schematic representation of the river network and its linestring geometries including divergences before (a) and after (b) the removal of minor paths. The linestring geometry with the feature_ids 7 and 8 have been removed from the river network in B, because they intersect other linestring geometries with both, the start and end node.')}
include_graphics("data_descriptor/tex/divergences_scheme.pdf")
```

```{r coastlineplot, echo=FALSE, out.width = "60%", fig.showtext = TRUE, fig.cap= "Map showing location and the spatial distribution of coastline and administrative borders over land resulting from the preprocessing."}
tar_read(coastline_plot)
```

```{r statsridgeplot, echo=FALSE, out.width = "70%", fig.showtext = TRUE, fig.cap= "Ridgelines showing the distribution of the three measures DSD (a), LP (b) and SD (c) for all nine hydrologic orders. The white tick mark represents the median."}
tar_read(stats_ridge_plot)
```

```{r datasetmaphydrologicorder9plot, echo=FALSE, out.width = "80%", fig.height = 2.5, fig.showtext = TRUE, fig.cap= "Resulting maps of the three EU-MOHP measures DSD, LP and SD (from left to right) for the 9th hydrologic order."}
tar_read(dataset_map_hydrologicorder9_plot)
```

```{r comparisondifferencepatchwork, echo=FALSE, out.width = "100%", fig.height=2.2, fig.showtext = TRUE, fig.cap= "Maps showing the Original LP7 (a), the Reproduced LP7 (b) and the absolute difference between Original LP7 and the Reproduced LP7 (c) for the contiguous US."}
tar_read(comparison_difference_patchwork)
```

```{r accuracypatchwork, echo=FALSE, out.width = "100%", fig.height = 3, fig.showtext = TRUE, fig.cap= "a) Sampling strategy for the quantitative cross-comparison. The sampling locations are shown in yellow. Due to aesthetic reasons, only half of the total 10,000 points are shown here. b) Raster cell values at the sampling points for the Original LP7 and Reproduced LP7. The ${R}^2$ of the linear regression model is 0.987. The point colour represents point density with yellow for high to blue for low density."}
tar_read(accuracy_patchwork)
```

```{r rivercanalconfusionplot, echo=FALSE, out.width = "80%", fig.showtext = TRUE, fig.cap= "Example of the river network data showing the confusion between the values BH140 (river), BH020 (canal) and BH030 (ditch) of the attribute column dfdd of the river network dataset\\cite{noauthor_eu-hydro_2021}."}
tar_read(river_canal_confusion_plot)
```

```{r ddinaccuracies, echo=FALSE, out.width = "70%", fig.showtext = TRUE, fig.cap= 'Schematic example showing the source of inaccurate of DD in areas near headwaters caused by the applied method to calculate DD. The red distance as DD is incorrect, because it crosses the stream and therefore does not fulfill the defined condition. The correct DD would be the dark grey distance. The path to the correct side is equal to the correct DD (dark grey solid line) and therefore not drawn on the schematic map.'}
include_graphics("data_descriptor/tex/dd_inaccuracies.pdf")
```

```{r projectdirtree, crop=TRUE, echo=FALSE, out.width = "50%", fig.cap="Directory tree of the project directory; only relevant subdirectories and files are listed here."}
include_graphics("data_descriptor/tex/directory_tree.pdf")
```

```{r outputdata, echo=FALSE}
targets::tar_read(output_data_table) %>% 
    kableExtra::kable(
      "latex",
        booktabs = TRUE,
        caption = knitr:::escape_latex('Overview of the output file naming scheme and its placeholder values of the EU-MOHP dataset. Files for any combination of the placeholder values exists except for those study area polygons (<region name for spatial coverage>) that have no streams for certain hydrologic orders. The values are inserted for the respective placeholder in "mohp_europe_<region name for spatial coverage>_<abbreviation of the EU-MOHP measure>_<hydrologic order>_<spatial resolution>.tif". For example, selecting the first value of each placeholder results in the file name "mohp_europe_europemainland_dsd_hydrologicorder1_30m.tif". The spatial coverage of the values for "<region name for spatial coverage>" is shown in the mentioned interactive map in the Github repository.')) %>% 
  kableExtra::kable_styling(full_width = TRUE) %>% 
  kableExtra::column_spec(2, width = "12em") %>% 
  kableExtra::column_spec(3, width = "16em") %>%
  kableExtra::row_spec(0, align = "c") %>%
  kableExtra::collapse_rows()
```

```{r statstabledata, echo=FALSE}
table_data <- targets::tar_read(stats_table_data)
column_names <- table_data %>%
  names() %>%
  str_replace("hydrologic_order", "Hydrologic order") %>%
  str_remove("_dsd|_sd|_lp")

table_data %>%
  kableExtra::kable(
    "latex",
    booktabs = TRUE,
    align = c("c", rep("l", 12)),
    caption = "Statistical summary of the calculated measures DSD, LP and SD across all hydrologic orders.",
    col.names = column_names,
    linesep = ""
  ) %>%
  kableExtra::add_header_above(c(" " = 1, "DSD [km]" = 4, "LP [-]" = 4, "SD [km]" = 4)) %>%
  kableExtra::kable_styling(full_width = TRUE) %>%
  kableExtra::column_spec(1, width = "7em")
```

\renewcommand{\arraystretch}{2}
```{r inputdata, echo=FALSE}
targets::tar_read(input_data_table) %>% 
  select(-'Data type') %>% 
  kableExtra::kable("latex",
        booktabs = TRUE,
        caption = "Overview of the required input data.") %>% 
  kableExtra::kable_styling(full_width = TRUE) %>% 
  kableExtra::column_spec(1, width = "1em")
```
\renewcommand{\arraystretch}{1}

```{r runtime, echo=FALSE}
table_data <- tar_read(targets_runtime_table)

table_data %>%
  kableExtra::kable("latex",
    booktabs = TRUE,
    # longtable = TRUE,
    linesep = "",
    caption = "Overview of the runtime and data size of all targets or processing steps related to the generation of this dataset in descending order."
  ) %>%
  kableExtra::kable_styling(full_width = TRUE) %>%
  kableExtra::column_spec(1, width = "20em") %>%
  kableExtra::add_header_above(c(" " = 1, "Runtime" = 4, "Data size" = 1)) %>%
  kableExtra::row_spec(nrow(table_data), bold = TRUE) %>%
  kableExtra::row_spec(nrow(table_data) - 1, hline_after = T)
```
\FloatBarrier
